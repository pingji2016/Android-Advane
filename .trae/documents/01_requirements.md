# 横屏闯关小游戏需求文档（深化版）

## 1 项目概述
- **目标**：一款轻量级、横屏、**支持局域网联机合作/对抗**的平台闯关小游戏，安装包 ≤ 120 MB，支持在线增量更新关卡与资源。
- **资源策略**：优先复用开源美术与音效（Kenney、OpenGameArt），所有资源均注明作者与许可。
- **平台**：Android 8.0+，手机/平板，强制横屏。
- **商业模式**：免费、无内购、无广告，**局域网联机无需服务器**。

## 2 核心玩法（单机+联机）
### 2.1 单机
- 角色：左右移动、跳跃、二段跳（后期解锁）、基础攻击。
- 关卡：线性闯关，5–8 关首包内置；后续通过在线更新追加。
- 目标：到达终点或完成收集目标；评分维度：通关时间、收集率、死亡次数。
- 交互：虚拟按键（左/右/跳/攻）+ 可选手势；支持蓝牙手柄基础映射。

### 2.2 局域网联机
- **连接方式**：Wi-Fi P2P（Android 官方 API）+ NSD 服务发现，无需路由器，支持 2–4 人。
- **模式**：
  1. 合作闯关：共享关卡进度，队友可救援倒地玩家（倒计时 10 s）。
  2. 竞速对抗：同关卡同时起跑，先到达终点获胜；实时显示对手幽灵影像。
  3. 道具乱斗：拾取随机道具（加速、陷阱、护盾、混乱）攻击对手，血量归零即淘汰，最后存活者获胜。
- **实时同步**：
  - 60 Hz 逻辑帧，关键事件（位置、状态、道具、伤害）可靠 UDP + 自定义回退/预测。
  - 延迟 ≤ 100 ms 局域网下；丢包率 ≤ 1 % 时无感知。
- **房间系统**：
  - 主机创建房间，自定义房间名、密码、模式、关卡；客户端搜索/扫码/手动输入加入。
  - 房间内聊天（预设短语+表情），准备状态，房主可踢人/开始游戏。
- **断线重连**：局域网下 30 s 内可重连，缓存玩家状态；主机掉线自动迁移（投票最高者）。

## 3 关卡系统
- 地图格式：Tiled 导出 JSON，瓦片尺寸 32×32 或 64×64。
- 层级：地形、装饰、交互、碰撞（单独层）。
- 难度曲线：新手→进阶→挑战；隐藏关卡可选。
- 通关解锁：前一关通过即可解锁下一关（单机）；联机时以房主进度为准。
- **联机关卡扩展**：
  - 同步机关（按钮、升降台）状态由主机权威；客户端预测表现。
  - 共享收集品（金币/宝石）每人独立计数，总分汇总。

## 4 实体与 AI
- 主角：状态（Idle、Run、Jump、Attack、Hurt、Dead、Downed）。
- 敌人（3–4 种）：
  1. 巡逻型：固定路线往返。
  2. 追踪型：发现玩家后追击，丢失后返回。
  3. 远程型：投掷物抛物线。
  4. 陷阱型：静态伤害区域。
- **联机增强**：
  - 敌人仇恨列表支持多目标；血量同步主机权威。
  - 道具：新增“团队回血”“群体加速”“陷阱放置”等联机专属道具。

## 5 UI/UX（单机+联机）
### 5.1 主菜单
- 开始游戏、关卡选择、**联机大厅**、设置、关于。

### 5.2 联机大厅
- **房间列表**：扫描局域网，显示房间名、模式、人数、延迟；支持刷新/筛选。
- **创建房间**：房间名、密码（可选）、模式、关卡、人数上限（2–4）。
- **快速匹配**：自动加入最优延迟房间。
- **扫码加入**：生成/扫描二维码（含房间 IP+端口+密码）。
- **房间内部**：
  - 玩家列表：昵称、准备状态、Ping、房主标识；支持踢人（房主）。
  - 聊天面板：预设短语+表情，支持键盘输入（可隐藏）。
  - 开始按钮：全员准备后房主可开始；未准备者提示。

### 5.3 关卡内
- 左上角：玩家昵称、血量、道具图标；队友缩略信息（联机）。
- 右上角：关卡时间、收集计数、对手幽灵进度条（竞速）。
- 虚拟按键：左/右/跳/攻、道具使用、救援交互（联机）。
- 暂停：设置、返回房间、退出到主菜单；联机时暂停仅本地，游戏继续。

### 5.4 结算
- 合作：团队总分、贡献榜、救助次数、死亡次数。
- 竞速：名次、用时、最佳记录对比、保存录像（本地幽灵）。
- 乱斗：击杀/死亡/助攻、道具使用统计、MVP。

### 5.5 设置
- 音量、操作方案、画质、**网络**（昵称、端口、回退预测开关）、在线更新、关于。

## 6 数据与存档
- 本地 JSON：
  - `save.json`：关卡进度、每关最佳评分、解锁状态。
  - `settings.json`：音量、画质、操作方案、**联机昵称、端口、最近房间列表**。
  - `ghost.json`：竞速最佳录像（输入序列+时间戳），用于幽灵影像回放。
- 联机缓存：
  - `lan_cache/`：最近 20 条房间信息、玩家头像缩略图（Base64）。

## 7 在线更新（同单机）
- 资源清单 `manifest.json` 托管于远端 CDN，包含版本号、资源列表、SHA256、大小、下载地址。
- 触发时机：启动时（可选）、设置页手动检查。
- 流程：获取清单 → 差异计算 → 增量下载 → 校验 → 落地到 `filesDir/assets/<version>/` → 更新索引 → 重启游戏生效。
- 回滚：加载失败时自动回退到上一版本；保证离线可玩。

## 8 性能与质量
- 帧率：中端机 60 fps，低端机保底 30 fps。
- 渲染预算 ≤ 16 ms，逻辑预算 ≤ 4 ms；联机时网络线程独立，不阻塞渲染。
- 资源按需加载，图集合并，音频压缩（OGG）。
- 冷启动 ≤ 2 s，关卡加载 ≤ 1 s。
- **联机网络**：单包 ≤ 512 B，每秒上行 ≤ 30 KB（4 人），下行 ≤ 30 KB；局域网带宽充足时无感知。

## 9 安全与合规
- 资源哈希校验，防止篡改。
- 不采集隐私数据，无联网权限（仅更新时主动请求）；**局域网联机仅本地网络，不访问互联网**。
- 开源资源注明许可与作者，放置“关于”页。

## 10 本地化与可访问性
- 语言：简体中文、English。
- 高对比度 UI 选项，按键尺寸可调，色盲友好配色开关。

## 11 里程碑（单机+联机）
| 阶段 | 目标 |
|------|------|
| M1 | 可运行原型：角色移动跳跃 + 1 张测试关卡 |
| M2 | 完整关卡系统 + 5 关 + 存档 |
| M3 | 在线更新：清单、下载、校验、切换 |
| M4 | **局域网联机：房间创建、加入、合作模式** |
| M5 | **竞速对抗 + 道具乱斗 + 幽灵录像 + 聊天** |
| M6 | UI 打磨、音效、手柄支持、性能优化、发布 |

## 12 风险与约束
- 多分辨率适配与输入兼容。
- 在线更新依赖 CDN 可用性与网络稳定性。
- 低端机性能瓶颈需持续 Profiling。
- **局域网联机**：部分老旧设备 Wi-Fi P2P 支持不完整，需提示兼容列表。